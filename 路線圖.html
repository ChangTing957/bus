<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>查詢台中公車路線 起站/終站</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label { display: inline-block; width: 80px; }
    #result { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>台中公車起迄站查詢</h1>
  <div>
    <label>公車路線：</label>
    <input type="text" id="routeInput" placeholder="如 300、70A、127延…">
    <button id="searchBtn">查詢</button>
  </div>
  <div id="result"></div>

  <script>
    // 請填入您自己的 TDX Client ID、Secret
    const CLIENT_ID = "niyangex-c9a03f8f-f658-4f40";
    const CLIENT_SECRET = "f0067ed7-d17c-422f-8306-491a54480a14";

    // 綁定查詢按鈕事件
    document.getElementById("searchBtn").addEventListener("click", async () => {
      const routeName = document.getElementById("routeInput").value.trim();
      if (!routeName) {
        alert("請輸入公車路線名稱");
        return;
      }

      // 取得 TDX Token
      let token;
      try {
        token = await getTDXToken();
      } catch (error) {
        alert("取得 TDX Token 失敗");
        console.error(error);
        return;
      }

      // 呼叫 API 查詢路線
      try {
        const routeData = await fetchTaichungRoute(token, routeName);
        showResult(routeData, routeName);
      } catch (error) {
        alert("查詢路線資料失敗");
        console.error(error);
      }
    });

    // 取得 TDX Token (OAuth2 Client Credentials)
    async function getTDXToken() {
      const url = "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token";
      const params = new URLSearchParams();
      params.append("grant_type", "client_credentials");
      params.append("client_id", CLIENT_ID);
      params.append("client_secret", CLIENT_SECRET);

      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params.toString()
      });
      const result = await response.json();
      if (!result.access_token) {
        throw new Error("無法取得 access_token");
      }
      return result.access_token;
    }

    // 查詢台中市公車路線
    async function fetchTaichungRoute(token, routeName) {
      const apiUrl = `https://tdx.transportdata.tw/api/basic/v2/Bus/Route/City/Taichung?$filter=RouteName/Zh_tw eq '${routeName}'&$format=JSON`;
      const response = await fetch(apiUrl, {
        headers: {
          "Authorization": "Bearer " + token
        }
      });
      if (!response.ok) {
        throw new Error("TDX API 回應錯誤: " + response.status);
      }
      const data = await response.json();
      return data; // 通常是一個陣列
    }

    // 顯示查詢結果
    function showResult(routeData, routeName) {
      const resultDiv = document.getElementById("result");
      if (!Array.isArray(routeData) || routeData.length === 0) {
        resultDiv.innerHTML = `<p>查無「${routeName}」路線資料</p>`;
        return;
      }
      // 多筆時只示範顯示第一筆
      const routeInfo = routeData[0];
      const departure = routeInfo.DepartureStopNameZh || "未知";
      const destination = routeInfo.DestinationStopNameZh || "未知";

      resultDiv.innerHTML = `
        <h2>查詢結果</h2>
        <p>路線名稱：${routeName}</p>
        <p>起點站：${departure}</p>
        <p>終點站：${destination}</p>
      `;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>毛玻璃 + Google Maps (捲簾式、可放大/收合)</title>
  <style>
    /* 讓頁面填滿視窗 */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /*
      主面板 (裝地圖)
      - 去掉底部圓角，以免看起來有「下邊一條線」。
      - 用同樣的毛玻璃效果 (rgba + backdrop-filter)。
    */
    #mainPanel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 90%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow:
        0 -5px 5px rgba(0, 0, 0, 0.5), /* 上 */
        5px 0 5px rgba(0, 0, 0, 0.5),  /* 右 */
        -5px 0 5px rgba(0, 0, 0, 0.5); /* 左 */
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      /* 讓底部是直角，避免多一道邊界 */
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;

      overflow: hidden;
      z-index: 999; /* 地圖層級 */
    }

    /* 地圖容器 */
    #map {
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.320, 1.275);
    }

    #mainPanel, #infoPanel {
      box-sizing: border-box;
      width: 70%;
    }

    /* 資訊面板初始：height=50% */
    #infoPanel {
      position: absolute;
      left: 0;
      bottom: 0;
      z-index: 1000;
      width: 100%;
      height: 50%;
      margin: 0;

      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
      box-shadow:
        5px 0 5px rgba(0, 0, 0, 0.3),  /* 右 */
        -5px 0 5px rgba(0, 0, 0, 0.3), /* 左 */
        0 5px 5px rgba(0, 0, 0, 0.3);  /* 下 */
        box-sizing: border-box;
      padding: 10px;
      font-family: sans-serif;
      overflow: auto;

      /* 滑動 + 高度動畫 */
      transition: transform 0.4s ease-out, height 0.4s ease-out;
      transform: translateY(100%); /* 預設不顯示 (藏在下方) */
      display: flex; 
      flex-direction: column;
      justify-content: space-between;
    }

    /* .open => 往上滑出 */
    #infoPanel.open {
      transform: translateY(0);
    }

    /* .big => 面板高度變更大 (80%) */
    #infoPanel.big {
      height: 90%;
    }

    /* 關閉按鈕 */
    #closeBtn {
      float: right;
      background: #ccc;
      border: none;
      font-weight: bold;
      cursor: pointer;
      padding: 4px 8px;
      margin-top: -6px;
      margin-right: -6px;
      border-radius: 4px;
    }

    /* Tab 樣式 */
    .tabs {
      margin-bottom: 10px;
      clear: both;
    }

    .tabs button {
      padding: 6px 12px;
      margin-right: 6px;
      cursor: pointer;
    }

    .tabs button.active {
      background-color: #ccc;
    }

    /* 分頁內容區塊 */
    .tab-content {
      flex: 1; /* 撐滿剩餘空間 */
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* 內容與底部對齊 */
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    /* 確保內容有適當的內邊距 */
.tab-content p {
  margin: 0;
  padding: 10px;
}

    .tab-content.active {
      display: block;
    }
  </style>
</head>

<body>
  <button onclick="findNearestFiveStops()">搜尋最近五站</button>

  <!-- 地圖主面板 -->
  <div id="mainPanel">
    <div id="map"></div>

    <!-- 資訊面板 -->
    <div id="infoPanel">
      <!-- 關閉按鈕 -->
      <button id="closeBtn">X</button>

      <h3 id="stationTitle">站名</h3>
<!-- 兩個按鈕做為 Tab -->
<div class="tabs">
  <button id="goBtn" class="active">去程</button>
  <button id="backBtn">回程</button>
</div>
<!-- 兩個分頁內容 -->
<div id="goContent" class="tab-content active">
  <p>去程資料</p>
</div>
<div id="backContent" class="tab-content">
  <p>回程資料</p>
</div>
</div>
  </div>

  <script>
let map;
let userMarker;
let infoWindow;
let panelJustOpened = false;

function initMap() {
  const initialCenter = { lat: 24.1508, lng: 120.6510 };
  map = new google.maps.Map(document.getElementById("map"), {
    center: initialCenter,
    zoom: 16,
    styles: [
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "transit.station", stylers: [{ visibility: "off" }] }
    ]
  });
  infoWindow = new google.maps.InfoWindow();

  // 綁定 Tab 切換事件
  document.getElementById('goBtn').addEventListener('click', () => showTab('go'));
  document.getElementById('backBtn').addEventListener('click', () => showTab('back'));

  // 綁定關閉按鈕事件
  document.getElementById('closeBtn').addEventListener('click', () => {
    closeInfoPanel();
  });

  // 點擊資訊面板本身則讓面板變大（展開更多資訊）
  const infoPanel = document.getElementById('infoPanel');
  infoPanel.addEventListener('click', (e) => {
    // 避免事件冒泡到 map 的 click
    e.stopPropagation();
    if (infoPanel.classList.contains('open') && !infoPanel.classList.contains('big')) {
      infoPanel.classList.add('big');
    }
  });

  // 地圖點擊事件：點擊 map (非 marker 或 infoPanel)時關閉面板
  map.addListener("click", () => {
    const infoPanel = document.getElementById('infoPanel');
    if (infoPanel.classList.contains('open')) {
      closeInfoPanel();
    }
  });

  // 全域 document click 事件：如果點擊目標不在 infoPanel 內且不是剛剛開啟的，就關閉面板
  document.addEventListener('click', function(e) {
    if (panelJustOpened) return;
    const infoPanel = document.getElementById('infoPanel');
    if (infoPanel.classList.contains('open') && !infoPanel.contains(e.target)) {
      closeInfoPanel();
    }
  });

  // 確保地圖 zoom 不低於 16
  google.maps.event.addListenerOnce(map, "idle", () => {
    if (map.getZoom() < 16) {
      map.setZoom(16);
    }
  });
}

function closeInfoPanel() {
  const infoPanel = document.getElementById('infoPanel');
  infoPanel.classList.remove('big');
  infoPanel.classList.remove('open');
  setTimeout(() => {
    infoPanel.style.display = 'none';
  }, 600);
}

function showTab(tab) {
  const goBtn = document.getElementById('goBtn');
  const backBtn = document.getElementById('backBtn');
  const goContent = document.getElementById('goContent');
  const backContent = document.getElementById('backContent');

  if (tab === 'go') {
    goBtn.classList.add('active');
    backBtn.classList.remove('active');
    goContent.classList.add('active');
    backContent.classList.remove('active');
  } else {
    goBtn.classList.remove('active');
    backBtn.classList.add('active');
    goContent.classList.remove('active');
    backContent.classList.add('active');
  }
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6378137;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

async function handleNearestStops(userLat, userLng) {
  console.log(`使用座標：lat=${userLat}, lng=${userLng}`);

  if (userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({
    position: { lat: userLat, lng: userLng },
    map: map,
    title: "我的位置",
    icon: {
      path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
      fillColor: "#4285F4",
      fillOpacity: 1,
      strokeColor: "#FFFFFF",
      strokeWeight: 2,
      scale: 6,
    },
    zIndex: 9999,
  });

  try {
    const response = await fetch("json/公車站座標.json");
    const data = await response.json();
    const stops = [];
    for (const stationName in data) {
      const stationData = data[stationName];
      let coords = null;
      if (stationData["去程"] && stationData["去程"]["經度"] && stationData["去程"]["緯度"]) {
        coords = stationData["去程"];
      } else if (stationData["回程"] && stationData["回程"]["經度"] && stationData["回程"]["緯度"]) {
        coords = stationData["回程"];
      } else {
        console.warn(`站名 "${stationName}" 缺少經緯度資訊`);
        continue;
      }
      const lat = parseFloat(coords["緯度"]);
      const lng = parseFloat(coords["經度"]);
      const dist = getDistance(userLat, userLng, lat, lng);
      stops.push({ stationName, lat, lng, distance: dist, rawData: stationData });
    }

    stops.sort((a, b) => a.distance - b.distance);
    const nearestFive = stops.slice(0, 5);
    const bounds = new google.maps.LatLngBounds();
    bounds.extend({ lat: userLat, lng: userLng });

    nearestFive.forEach((stop) => {
      const marker = new google.maps.Marker({
        position: { lat: stop.lat, lng: stop.lng },
        map: map,
        icon: "http://maps.google.com/mapfiles/ms/icons/bus.png",
      });

      marker.addListener("click", () => {
        map.panTo(marker.getPosition());
        const infoPanel = document.getElementById('infoPanel');
        infoPanel.style.display = "block";
        infoPanel.classList.remove('big');
        void infoPanel.offsetWidth; // 強制 reflow
        infoPanel.classList.add("open");

        document.getElementById('stationTitle').textContent = stop.stationName;
        const goData = stop.rawData["去程"];
        const backData = stop.rawData["回程"];
        document.getElementById('goContent').innerHTML = goData
          ? `<p>去程經度: ${goData["經度"]}, 緯度: ${goData["緯度"]}</p>`
          : "<p>無去程資料</p>";
        document.getElementById('backContent').innerHTML = backData
          ? `<p>回程經度: ${backData["經度"]}, 緯度: ${backData["緯度"]}</p>`
          : "<p>無回程資料</p>";
        showTab('go');

        // 設定 flag，避免剛開啟時 document click 立即關閉面板
        panelJustOpened = true;
        setTimeout(() => { panelJustOpened = false; }, 10);
      });

      bounds.extend({ lat: stop.lat, lng: stop.lng });
    });

    map.fitBounds(bounds);
    google.maps.event.addListenerOnce(map, "idle", () => {
      if (map.getZoom() < 16) {
        map.setZoom(16);
      }
    });
  } catch (error) {
    console.error("載入或處理 JSON 時發生錯誤：", error);
  }
}

function findNearestFiveStops() {
  const fixedLat = 24.150814543462218;
  const fixedLng = 120.65102123486855;
  handleNearestStops(fixedLat, fixedLng);
} 
  </script>

  <!-- 載入 Google Maps JavaScript API (替換成你的 API Key) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJnEKvcG6N6KdtutVViDu6KjHxqIa6jBI&callback=initMap"
    async defer>
  </script>
</body>

</html>
